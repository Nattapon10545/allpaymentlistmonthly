<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกรายการเบิกจ่าย - โรงเรียนบ้านกิ่วพร้าว</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Loading Overlay -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #1134A6;
            --primary-light: #e8f0ff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }
        
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 1200px;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary-color), #2d5aa0);
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }
        
        .school-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            margin-bottom: 15px;
        }
        
        .system-title {
            font-family: 'Kanit', sans-serif;
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .school-name {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content-section {
            padding: 30px;
        }
        
        .filter-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .data-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            padding: 25px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: #0d2d8f;
            border-color: #0d2d8f;
        }
        
        .btn-success {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 10px;
            padding: 8px 16px;
        }
        
        .btn-outline-primary:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .table thead th {
            background: var(--primary-color);
            color: white;
            border: none;
            font-weight: 600;
            padding: 15px 12px;
        }
        
        .table tbody td {
            padding: 12px;
            vertical-align: middle;
            border-color: #f0f0f0;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9ff;
        }
        
        .badge {
            font-size: 0.75rem;
            padding: 6px 12px;
            border-radius: 20px;
        }
        
        .money-type-1 { background-color: #e3f2fd; color: #1976d2; }
        .money-type-2 { background-color: #f3e5f5; color: #7b1fa2; }
        .money-type-3 { background-color: #e8f5e8; color: #388e3c; }
        .money-type-4 { background-color: #fff3e0; color: #f57c00; }
        .money-type-5 { background-color: #fce4ec; color: #c2185b; }
        .money-type-6 { background-color: #e0f2f1; color: #00796b; }
        .money-type-7 { background-color: #fff8e1; color: #fbc02d; }
        .money-type-8 { background-color: #f1f8e9; color: #689f38; }
        .money-type-9 { background-color: #e8eaf6; color: #3f51b5; }
        .money-type-10 { background-color: #ffebee; color: #d32f2f; }
        .money-type-11 { background-color: #e0f7fa; color: #0097a7; }
        
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #2d5aa0);
            color: white;
            border-radius: 15px 15px 0 0;
            border-bottom: none;
            padding: 20px 25px;
        }
        
        .modal-title {
            font-family: 'Kanit', sans-serif;
            font-weight: 600;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(17, 52, 166, 0.25);
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .pagination {
            justify-content: center;
            margin-top: 25px;
        }
        
        .page-link {
            color: var(--primary-color);
            border-color: #dee2e6;
            border-radius: 8px;
            margin: 0 2px;
            padding: 10px 15px;
        }
        
        .page-link:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
            border-radius: 6px;
        }
        
        .amount-income {
            color: var(--success-color);
            font-weight: 600;
        }
        
        .amount-expense {
            color: var(--danger-color);
            font-weight: 600;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        
        .summary-card h5 {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .summary-card h3 {
            font-family: 'Kanit', sans-serif;
            font-weight: 600;
            margin: 0;
        }
        
        @media (max-width: 768px) {
            .system-title {
                font-size: 1.8rem;
            }
            
            .school-logo {
                width: 60px;
                height: 60px;
            }
            
            .content-section {
                padding: 20px;
            }
            
            .filter-card, .data-card {
                padding: 20px;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 3px;
            }
            
            .btn-sm {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header Section -->
            <div class="header-section">
                <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" alt="โรงเรียนบ้านกิ่วพร้าว" class="school-logo">
                <h1 class="system-title">ระบบบันทึกรายการเบิกจ่าย</h1>
                <p class="school-name">โรงเรียนบ้านกิ่วพร้าว</p>
            </div>
            
            <!-- Content Section -->
            <div class="content-section">
                <!-- Summary Cards -->
                <div class="summary-cards">
                    <div class="summary-card">
                        <h5>รายรับทั้งหมด</h5>
                        <h3 class="amount-income" id="totalIncome">0.00 บาท</h3>
                    </div>
                    <div class="summary-card">
                        <h5>รายจ่ายทั้งหมด</h5>
                        <h3 class="amount-expense" id="totalExpense">0.00 บาท</h3>
                    </div>
                    <div class="summary-card">
                        <h5>คงเหลือ</h5>
                        <h3 id="totalBalance">0.00 บาท</h3>
                    </div>
                </div>
                
                <!-- Filter Section -->
                <div class="filter-card">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label for="filterMonth" class="form-label">เดือน</label>
                            <select class="form-select" id="filterMonth">
                                <option value="">ทุกเดือน</option>
                                <option value="1">มกราคม</option>
                                <option value="2">กุมภาพันธ์</option>
                                <option value="3">มีนาคม</option>
                                <option value="4">เมษายน</option>
                                <option value="5">พฤษภาคม</option>
                                <option value="6">มิถุนายน</option>
                                <option value="7">กรกฎาคม</option>
                                <option value="8">สิงหาคม</option>
                                <option value="9">กันยายน</option>
                                <option value="10">ตุลาคม</option>
                                <option value="11">พฤศจิกายน</option>
                                <option value="12">ธันวาคม</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterYear" class="form-label">ปีงบประมาณ</label>
                            <select class="form-select" id="filterYear">
                                <option value="">ทุกปี</option>
                                <option value="2568">2568</option>
                                <option value="2569">2569</option>
                                <option value="2570">2570</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2 flex-wrap">
                                <button type="button" class="btn btn-outline-primary" onclick="filterData()">
                                    <i class="fas fa-filter"></i> กรองข้อมูล
                                </button>
                                <button type="button" class="btn btn-success" onclick="showAddIncomeModal()">
                                    <i class="fas fa-plus"></i> เพิ่มรายการรับ
                                </button>
                                <button type="button" class="btn btn-primary" onclick="showAddExpenseModal()">
                                    <i class="fas fa-plus"></i> เพิ่มรายการเบิกจ่าย
                                </button>
                                <button type="button" class="btn btn-warning" onclick="showExportModal()">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Table -->
                <div class="data-card">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>วันที่</th>
                                    <th>ประเภท</th>
                                    <th>เอกสาร</th>
                                    <th>ปีงบประมาณ</th>
                                    <th>ประเภทเงิน</th>
                                    <th>รายการ</th>
                                    <th>จำนวนเงิน</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination" id="pagination">
                            <!-- Pagination will be generated here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Modal -->
    <div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="dataModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dataModalLabel">เพิ่มรายการ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="dataForm">
                        <input type="hidden" id="editId" value="">
                        <input type="hidden" id="transactionType" value="">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="documentType" class="form-label">ประเภทเอกสาร</label>
                                    <select class="form-select" id="documentType" required>
                                        <option value="">เลือกประเภทเอกสาร</option>
                                        <option value="บค.">บค.</option>
                                        <option value="บจ.">บจ.</option>
                                        <option value="บร.">บร.</option>
                                        <option value="บก.">บก.</option>
                                        <option value="บย.">บย.</option>
                                        <option value="บถ.">บถ.</option>
                                        <option value="บฝ.">บฝ.</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="budgetYear" class="form-label">ปีงบประมาณ</label>
                                    <select class="form-select" id="budgetYear" required>
                                        <option value="">เลือกปีงบประมาณ</option>
                                        <option value="2568">2568</option>
                                        <option value="2569">2569</option>
                                        <option value="2570">2570</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="moneyType" class="form-label">ประเภทเงิน</label>
                            <select class="form-select" id="moneyType" required>
                                <option value="">เลือกประเภทเงิน</option>
                                <option value="ค่าจัดการเรียนการสอน">ค่าจัดการเรียนการสอน</option>
                                <option value="ค่าหนังสือเรียน">ค่าหนังสือเรียน</option>
                                <option value="ค่าอุปกรณ์การเรียน">ค่าอุปกรณ์การเรียน</option>
                                <option value="ค่าเครื่องแบบนักเรียน">ค่าเครื่องแบบนักเรียน</option>
                                <option value="ค่ากิจกรรมพัฒนาคุณภาพผู้เรียน">ค่ากิจกรรมพัฒนาคุณภาพผู้เรียน</option>
                                <option value="ปัจจัยพื้นฐานนักเรียนยากจน">ปัจจัยพื้นฐานนักเรียนยากจน</option>
                                <option value="อาหารกลางวัน">อาหารกลางวัน</option>
                                <option value="รายได้สถานศึกษา">รายได้สถานศึกษา</option>
                                <option value="กสศ.">กสศ.</option>
                                <option value="ภาษี">ภาษี</option>
                                <option value="ดอกเบี้ย">ดอกเบี้ย</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="documentNumber" class="form-label">เลขที่เอกสาร</label>
                            <input type="text" class="form-control" id="documentNumber" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">รายการ</label>
                            <textarea class="form-control" id="description" rows="3" required></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="amount" class="form-label">จำนวนเงิน (บาท)</label>
                                    <input type="number" class="form-control" id="amount" step="0.01" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="transactionDate" class="form-label">วันที่</label>
                                    <input type="date" class="form-control" id="transactionDate" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveData()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalLabel">รายละเอียดรายการ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailModalBody">
                    <!-- Detail content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportModalLabel">Export ข้อมูลเป็น Excel</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="exportForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="exportMonth" class="form-label">เดือน</label>
                                    <select class="form-select" id="exportMonth" required>
                                        <option value="">เลือกเดือน</option>
                                        <option value="1">มกราคม</option>
                                        <option value="2">กุมภาพันธ์</option>
                                        <option value="3">มีนาคม</option>
                                        <option value="4">เมษายน</option>
                                        <option value="5">พฤษภาคม</option>
                                        <option value="6">มิถุนายน</option>
                                        <option value="7">กรกฎาคม</option>
                                        <option value="8">สิงหาคม</option>
                                        <option value="9">กันยายน</option>
                                        <option value="10">ตุลาคม</option>
                                        <option value="11">พฤศจิกายน</option>
                                        <option value="12">ธันวาคม</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="exportYear" class="form-label">ปีงบประมาณ</label>
                                    <select class="form-select" id="exportYear" required>
                                        <option value="">เลือกปี</option>
                                        <option value="2568">2568</option>
                                        <option value="2569">2569</option>
                                        <option value="2570">2570</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-warning" onclick="exportToExcel()">
                        <i class="fas fa-download"></i> ดาวน์โหลด Excel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, push, set, get, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCVnXN5j7GhQEMRFLk7UJ2UsxAouPmB6w",
            authDomain: "listpayment-fe19e.firebaseapp.com",
            databaseURL: "https://listpayment-fe19e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "listpayment-fe19e",
            storageBucket: "listpayment-fe19e.firebasestorage.app",
            messagingSenderId: "643338335043",
            appId: "1:643338335043:web:0222b5664a68881ea2b5f6",
            measurementId: "G-WJXTV70VWQ"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Global variables
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        
        // Money type colors mapping
        const moneyTypeColors = {
            'ค่าจัดการเรียนการสอน': 'money-type-1',
            'ค่าหนังสือเรียน': 'money-type-2',
            'ค่าอุปกรณ์การเรียน': 'money-type-3',
            'ค่าเครื่องแบบนักเรียน': 'money-type-4',
            'ค่ากิจกรรมพัฒนาคุณภาพผู้เรียน': 'money-type-5',
            'ปัจจัยพื้นฐานนักเรียนยากจน': 'money-type-6',
            'อาหารกลางวัน': 'money-type-7',
            'รายได้สถานศึกษา': 'money-type-8',
            'กสศ.': 'money-type-9',
            'ภาษี': 'money-type-10',
            'ดอกเบี้ย': 'money-type-11'
        };
        
        // Load data from Firebase
        function loadData() {
            $.LoadingOverlay("show");
            const dataRef = ref(database, 'transactions');
            
            onValue(dataRef, (snapshot) => {
                allData = [];
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    Object.keys(data).forEach(key => {
                        allData.push({
                            id: key,
                            ...data[key]
                        });
                    });
                }
                
                // Sort by date (newest first)
                allData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                filteredData = [...allData];
                updateSummary();
                displayData();
                $.LoadingOverlay("hide");
            });
        }
        
        // Update summary cards
        function updateSummary() {
            let totalIncome = 0;
            let totalExpense = 0;
            
            filteredData.forEach(item => {
                if (item.type === 'income') {
                    totalIncome += parseFloat(item.amount);
                } else {
                    totalExpense += parseFloat(item.amount);
                }
            });
            
            const balance = totalIncome - totalExpense;
            
            document.getElementById('totalIncome').textContent = totalIncome.toLocaleString('th-TH', {minimumFractionDigits: 2}) + ' บาท';
            document.getElementById('totalExpense').textContent = totalExpense.toLocaleString('th-TH', {minimumFractionDigits: 2}) + ' บาท';
            
            const balanceElement = document.getElementById('totalBalance');
            balanceElement.textContent = balance.toLocaleString('th-TH', {minimumFractionDigits: 2}) + ' บาท';
            balanceElement.className = balance >= 0 ? 'amount-income' : 'amount-expense';
        }
        
        // Display data in table
        function displayData() {
            const tbody = document.getElementById('dataTableBody');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">ไม่พบข้อมูล</td></tr>';
                return;
            }
            
            pageData.forEach(item => {
                const row = document.createElement('tr');
                const formattedDate = new Date(item.date).toLocaleDateString('th-TH');
                const typeText = item.type === 'income' ? 'รับ' : 'จ่าย';
                const typeClass = item.type === 'income' ? 'badge bg-success' : 'badge bg-danger';
                const amountClass = item.type === 'income' ? 'amount-income' : 'amount-expense';
                const moneyTypeClass = moneyTypeColors[item.moneyType] || 'money-type-1';
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td><span class="${typeClass}">${typeText}</span></td>
                    <td>${item.documentType}</td>
                    <td>${item.budgetYear}</td>
                    <td><span class="badge ${moneyTypeClass}">${item.moneyType}</span></td>
                    <td>${item.description}</td>
                    <td class="${amountClass}">${parseFloat(item.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} บาท</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="showDetail('${item.id}')">
                                <i class="fas fa-eye"></i> ดู
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editData('${item.id}')">
                                <i class="fas fa-edit"></i> แก้ไข
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteData('${item.id}')">
                                <i class="fas fa-trash"></i> ลบ
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updatePagination();
        }
        
        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ก่อนหน้า</a>`;
            pagination.appendChild(prevLi);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ถัดไป</a>`;
            pagination.appendChild(nextLi);
        }
        
        // Change page
        window.changePage = function(page) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            displayData();
        };
        
        // Filter data
        window.filterData = function() {
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;
            
            filteredData = allData.filter(item => {
                const itemDate = new Date(item.date);
                const itemMonth = itemDate.getMonth() + 1;
                const itemYear = parseInt(item.budgetYear);
                
                let matchMonth = !month || itemMonth == month;
                let matchYear = !year || itemYear == year;
                
                return matchMonth && matchYear;
            });
            
            currentPage = 1;
            updateSummary();
            displayData();
        };
        
        // Show add income modal
        window.showAddIncomeModal = function() {
            document.getElementById('dataModalLabel').textContent = 'เพิ่มรายการรับ';
            document.getElementById('transactionType').value = 'income';
            document.getElementById('editId').value = '';
            document.getElementById('dataForm').reset();
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            new bootstrap.Modal(document.getElementById('dataModal')).show();
        };
        
        // Show add expense modal
        window.showAddExpenseModal = function() {
            document.getElementById('dataModalLabel').textContent = 'เพิ่มรายการเบิกจ่าย';
            document.getElementById('transactionType').value = 'expense';
            document.getElementById('editId').value = '';
            document.getElementById('dataForm').reset();
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            new bootstrap.Modal(document.getElementById('dataModal')).show();
        };
        
        // Save data
        window.saveData = function() {
            const form = document.getElementById('dataForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            $.LoadingOverlay("show");
            
            const data = {
                type: document.getElementById('transactionType').value,
                documentType: document.getElementById('documentType').value,
                budgetYear: document.getElementById('budgetYear').value,
                moneyType: document.getElementById('moneyType').value,
                documentNumber: document.getElementById('documentNumber').value,
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                date: document.getElementById('transactionDate').value,
                createdAt: new Date().toISOString()
            };
            
            const editId = document.getElementById('editId').value;
            
            if (editId) {
                // Update existing record
                const dataRef = ref(database, `transactions/${editId}`);
                set(dataRef, data).then(() => {
                    $.LoadingOverlay("hide");
                    bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();
                    Swal.fire('สำเร็จ!', 'บันทึกข้อมูลเรียบร้อยแล้ว', 'success');
                }).catch((error) => {
                    $.LoadingOverlay("hide");
                    Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถบันทึกข้อมูลได้', 'error');
                });
            } else {
                // Add new record
                const dataRef = ref(database, 'transactions');
                push(dataRef, data).then(() => {
                    $.LoadingOverlay("hide");
                    bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();
                    Swal.fire('สำเร็จ!', 'บันทึกข้อมูลเรียบร้อยแล้ว', 'success');
                }).catch((error) => {
                    $.LoadingOverlay("hide");
                    Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถบันทึกข้อมูลได้', 'error');
                });
            }
        };
        
        // Edit data
        window.editData = function(id) {
            const item = allData.find(item => item.id === id);
            if (!item) return;
            
            document.getElementById('dataModalLabel').textContent = item.type === 'income' ? 'แก้ไขรายการรับ' : 'แก้ไขรายการเบิกจ่าย';
            document.getElementById('editId').value = id;
            document.getElementById('transactionType').value = item.type;
            document.getElementById('documentType').value = item.documentType;
            document.getElementById('budgetYear').value = item.budgetYear;
            document.getElementById('moneyType').value = item.moneyType;
            document.getElementById('documentNumber').value = item.documentNumber;
            document.getElementById('description').value = item.description;
            document.getElementById('amount').value = item.amount;
            document.getElementById('transactionDate').value = item.date;
            
            new bootstrap.Modal(document.getElementById('dataModal')).show();
        };
        
        // Show detail
        window.showDetail = function(id) {
            const item = allData.find(item => item.id === id);
            if (!item) return;
            
            const typeText = item.type === 'income' ? 'รายการรับ' : 'รายการเบิกจ่าย';
            const typeClass = item.type === 'income' ? 'text-success' : 'text-danger';
            const moneyTypeClass = moneyTypeColors[item.moneyType] || 'money-type-1';
            const formattedDate = new Date(item.date).toLocaleDateString('th-TH');
            
            document.getElementById('detailModalLabel').textContent = 'รายละเอียด' + typeText;
            document.getElementById('detailModalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>ประเภท:</strong> <span class="${typeClass}">${typeText}</span></p>
                        <p><strong>ประเภทเอกสาร:</strong> ${item.documentType}</p>
                        <p><strong>เลขที่เอกสาร:</strong> ${item.documentNumber}</p>
                        <p><strong>ปีงบประมาณ:</strong> ${item.budgetYear}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>ประเภทเงิน:</strong> <span class="badge ${moneyTypeClass}">${item.moneyType}</span></p>
                        <p><strong>จำนวนเงิน:</strong> <span class="${typeClass}">${parseFloat(item.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} บาท</span></p>
                        <p><strong>วันที่:</strong> ${formattedDate}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <p><strong>รายการ:</strong></p>
                        <div class="border rounded p-3 bg-light">
                            ${item.description}
                        </div>
                    </div>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        };
        
        // Delete data
        window.deleteData = function(id) {
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบรายการนี้หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.LoadingOverlay("show");
                    const dataRef = ref(database, `transactions/${id}`);
                    remove(dataRef).then(() => {
                        $.LoadingOverlay("hide");
                        Swal.fire('ลบแล้ว!', 'รายการถูกลบเรียบร้อยแล้ว', 'success');
                    }).catch((error) => {
                        $.LoadingOverlay("hide");
                        Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถลบรายการได้', 'error');
                    });
                }
            });
        };
        
        // Show export modal
        window.showExportModal = function() {
            // Set current month and year as default
            const now = new Date();
            document.getElementById('exportMonth').value = now.getMonth() + 1;
            document.getElementById('exportYear').value = '2568'; // Default budget year
            new bootstrap.Modal(document.getElementById('exportModal')).show();
        };
        
        // Export to Excel
        window.exportToExcel = function() {
            const form = document.getElementById('exportForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const month = document.getElementById('exportMonth').value;
            const year = document.getElementById('exportYear').value;
            
            if (!month || !year) {
                Swal.fire('กรุณาเลือกข้อมูล', 'กรุณาเลือกเดือนและปีที่ต้องการ Export', 'warning');
                return;
            }
            
            $.LoadingOverlay("show");
            
            // Filter data for export
            const exportData = allData.filter(item => {
                const itemDate = new Date(item.date);
                const itemMonth = itemDate.getMonth() + 1;
                const itemYear = parseInt(item.budgetYear);
                
                return itemMonth == month && itemYear == year;
            });
            
            if (exportData.length === 0) {
                $.LoadingOverlay("hide");
                Swal.fire('ไม่พบข้อมูล', 'ไม่พบข้อมูลในเดือนและปีที่เลือก', 'info');
                return;
            }
            
            // Prepare data for Excel
            const worksheetData = [];
            
            // Add header
            worksheetData.push([
                'วันที่',
                'ประเภท',
                'ประเภทเอกสาร',
                'เลขที่เอกสาร',
                'ปีงบประมาณ',
                'ประเภทเงิน',
                'รายการ',
                'จำนวนเงิน (บาท)'
            ]);
            
            // Add data rows
            exportData.forEach(item => {
                const formattedDate = new Date(item.date).toLocaleDateString('th-TH');
                const typeText = item.type === 'income' ? 'รับ' : 'จ่าย';
                
                worksheetData.push([
                    formattedDate,
                    typeText,
                    item.documentType,
                    item.documentNumber,
                    item.budgetYear,
                    item.moneyType,
                    item.description,
                    parseFloat(item.amount)
                ]);
            });
            
            // Calculate summary
            let totalIncome = 0;
            let totalExpense = 0;
            
            exportData.forEach(item => {
                if (item.type === 'income') {
                    totalIncome += parseFloat(item.amount);
                } else {
                    totalExpense += parseFloat(item.amount);
                }
            });
            
            const balance = totalIncome - totalExpense;
            
            // Add summary rows
            worksheetData.push([]);
            worksheetData.push(['สรุป']);
            worksheetData.push(['รายรับทั้งหมด', '', '', '', '', '', '', totalIncome]);
            worksheetData.push(['รายจ่ายทั้งหมด', '', '', '', '', '', '', totalExpense]);
            worksheetData.push(['คงเหลือ', '', '', '', '', '', '', balance]);
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            
            // Set column widths
            const colWidths = [
                { wch: 12 }, // วันที่
                { wch: 8 },  // ประเภท
                { wch: 12 }, // ประเภทเอกสาร
                { wch: 15 }, // เลขที่เอกสาร
                { wch: 12 }, // ปีงบประมาณ
                { wch: 25 }, // ประเภทเงิน
                { wch: 40 }, // รายการ
                { wch: 15 }  // จำนวนเงิน
            ];
            ws['!cols'] = colWidths;
            
            // Style header row
            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "1134A6" } },
                alignment: { horizontal: "center", vertical: "center" }
            };
            
            // Apply header style
            for (let col = 0; col < 8; col++) {
                const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!ws[cellRef]) ws[cellRef] = {};
                ws[cellRef].s = headerStyle;
            }
            
            // Style summary rows
            const summaryStyle = {
                font: { bold: true },
                fill: { fgColor: { rgb: "F0F0F0" } }
            };
            
            const summaryStartRow = worksheetData.length - 4;
            for (let row = summaryStartRow; row < worksheetData.length; row++) {
                for (let col = 0; col < 8; col++) {
                    const cellRef = XLSX.utils.encode_cell({ r: row, c: col });
                    if (!ws[cellRef]) ws[cellRef] = {};
                    ws[cellRef].s = summaryStyle;
                }
            }
            
            // Add worksheet to workbook
            const monthNames = [
                '', 'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
            ];
            
            const sheetName = `${monthNames[month]} ${year}`;
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            
            // Generate filename
            const filename = `รายการเบิกจ่าย_${monthNames[month]}_${year}.xlsx`;
            
            // Save file
            XLSX.writeFile(wb, filename);
            
            $.LoadingOverlay("hide");
            bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
            
            Swal.fire({
                title: 'Export สำเร็จ!',
                text: `ไฟล์ ${filename} ถูกดาวน์โหลดเรียบร้อยแล้ว`,
                icon: 'success',
                confirmButtonText: 'ตกลง'
            });
        };
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Set default date to today
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            
            // Close modal when clicking outside
            document.getElementById('dataModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    bootstrap.Modal.getInstance(this).hide();
                }
            });
            
            document.getElementById('detailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    bootstrap.Modal.getInstance(this).hide();
                }
            });
            
            document.getElementById('exportModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    bootstrap.Modal.getInstance(this).hide();
                }
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'968f102ea4047996',t:'MTc1NDE1MzMxMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
