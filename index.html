<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกรายงานการเงิน - โรงเรียนบ้านกิ่วพร้าว</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-orange: #FFB366;
            --secondary-orange: #FF9A3D;
            --light-orange: #FFF2E6;
            --dark-orange: #E6935C;
        }
        
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #FFF2E6 0%, #FFE6CC 100%);
            min-height: 100vh;
        }
        
        .header-title {
            font-family: 'Kanit', sans-serif;
            color: var(--secondary-orange);
            font-weight: 600;
        }
        
        .card-custom {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(255, 154, 61, 0.1);
            border: none;
            overflow: hidden;
        }
        
        .btn-primary-custom {
            background: linear-gradient(45deg, var(--primary-orange), var(--secondary-orange));
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 154, 61, 0.3);
        }
        
        .table-custom {
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .table-custom thead {
            background: linear-gradient(45deg, var(--primary-orange), var(--secondary-orange));
            color: white;
        }
        
        .badge-money-type {
            font-size: 0.75rem;
            padding: 0.4rem 0.8rem;
            border-radius: 1rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-custom {
            width: 3rem;
            height: 3rem;
            border: 0.3rem solid var(--light-orange);
            border-top: 0.3rem solid var(--secondary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal-custom .modal-content {
            border-radius: 1rem;
            border: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .modal-custom .modal-header {
            background: linear-gradient(45deg, var(--primary-orange), var(--secondary-orange));
            color: white;
            border-radius: 1rem 1rem 0 0;
        }
        
        .form-control:focus {
            border-color: var(--secondary-orange);
            box-shadow: 0 0 0 0.2rem rgba(255, 154, 61, 0.25);
        }
        
        .pagination .page-link {
            color: var(--secondary-orange);
            border-color: var(--primary-orange);
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--secondary-orange);
            border-color: var(--secondary-orange);
        }
        
        .school-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .btn-sm-mobile {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
            
            .table-custom th,
            .table-custom td {
                padding: 0.5rem 0.25rem;
                vertical-align: middle;
            }
            
            .table-custom td:nth-child(7) {
                max-width: 150px;
            }
        }
        
        .table-custom {
            table-layout: fixed;
            width: 100%;
        }
        
        .table-custom th:nth-child(1) { width: 12%; }
        .table-custom th:nth-child(2) { width: 10%; }
        .table-custom th:nth-child(3) { width: 12%; }
        .table-custom th:nth-child(4) { width: 8%; }
        .table-custom th:nth-child(5) { width: 15%; }
        .table-custom th:nth-child(6) { width: 8%; }
        .table-custom th:nth-child(7) { width: 15%; }
        .table-custom th:nth-child(8) { width: 12%; }
        .table-custom th:nth-child(9) { width: 8%; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-custom"></div>
            <div class="mt-3 text-muted">กำลังประมวลผล...</div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" alt="โรงเรียนบ้านกิ่วพร้าว" class="school-logo mb-3">
                <h1 class="header-title mb-2">ระบบบันทึกรายงานการเงิน</h1>
                <h4 class="text-muted">โรงเรียนบ้านกิ่วพร้าว</h4>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <div class="col-12">
                <div class="card card-custom">
                    <div class="card-body p-4">
                        <!-- Filters and Controls -->
                        <div class="row mb-4">
                        <div class="col-md-3 mb-2">
                            <label class="form-label">เดือน</label>
                            <select class="form-select" id="monthFilter">
                                <option value="">ทุกเดือน</option>
                                <option value="1">มกราคม</option>
                                <option value="2">กุมภาพันธ์</option>
                                <option value="3">มีนาคม</option>
                                <option value="4">เมษายน</option>
                                <option value="5">พฤษภาคม</option>
                                <option value="6">มิถุนายน</option>
                                <option value="7">กรกฎาคม</option>
                                <option value="8">สิงหาคม</option>
                                <option value="9">กันยายน</option>
                                <option value="10">ตุลาคม</option>
                                <option value="11">พฤศจิกายน</option>
                                <option value="12">ธันวาคม</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label">ปี</label>
                            <select class="form-select" id="yearFilter">
                                <option value="">ทุกปี</option>
                                <option value="2568">2568</option>
                                <option value="2569">2569</option>
                                <option value="2570">2570</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">ประเภทเงิน</label>
                            <select class="form-select" id="moneyTypeFilter">
                                <option value="">ทุกประเภท</option>
                                <option value="ค่าจัดการเรียนการสอน">ค่าจัดการเรียนการสอน</option>
                                <option value="ค่าหนังสือเรียน">ค่าหนังสือเรียน</option>
                                <option value="ค่าอุปกรณ์การเรียน">ค่าอุปกรณ์การเรียน</option>
                                <option value="ค่าเครื่องแบบนักเรียน">ค่าเครื่องแบบนักเรียน</option>
                                <option value="ค่ากิจกรรมพัฒนาคุณภาพผู้เรียน">ค่ากิจกรรมพัฒนาคุณภาพผู้เรียน</option>
                                <option value="ปัจจัยพื้นฐานนักเรียนยากจน">ปัจจัยพื้นฐานนักเรียนยากจน</option>
                                <option value="อาหารกลางวัน">อาหารกลางวัน</option>
                                <option value="รายได้สถานศึกษา">รายได้สถานศึกษา</option>
                                <option value="กสศ.">กสศ.</option>
                                <option value="ภาษี">ภาษี</option>
                                <option value="ดอกเบี้ย">ดอกเบี้ย</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2 d-flex align-items-end">
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-primary-custom" onclick="addRecord()">
                                    <i class="fas fa-plus me-1"></i>เพิ่ม
                                </button>
                                <button class="btn btn-success" onclick="exportToExcel()" title="ส่งออกข้อมูล Excel">
                                    <i class="fas fa-file-excel"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-custom table-hover">
                            <thead>
                                <tr>
                                    <th>วันที่</th>
                                    <th>ประเภทเอกสาร</th>
                                    <th>เลขที่เอกสาร</th>
                                    <th>ปีงบประมาณ</th>
                                    <th>ประเภทเงิน</th>
                                    <th>ประเภทรายการ</th>
                                    <th>รายการ</th>
                                    <th>จำนวนเงิน</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTable">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination will be populated here -->
                        </ul>
                    </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Record Modal -->
    <div class="modal fade modal-custom" id="recordModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">เพิ่มรายการใหม่</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="recordForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">วันที่ <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="recordDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ประเภทเอกสาร <span class="text-danger">*</span></label>
                                <select class="form-select" id="documentType" required>
                                    <option value="">เลือกประเภทเอกสาร</option>
                                    <option value="บค.">บค.</option>
                                    <option value="บจ.">บจ.</option>
                                    <option value="บร.">บร.</option>
                                    <option value="บก.">บก.</option>
                                    <option value="บย.">บย.</option>
                                    <option value="บถ.">บถ.</option>
                                    <option value="บฝ.">บฝ.</option>
                                    <option value="อื่นๆ">อื่นๆ</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ประเภทเอกสารอื่นๆ</label>
                                <input type="text" class="form-control" id="customDocumentType" style="display: none;">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">เลขที่เอกสาร <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="documentNumber" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ปีงบประมาณ <span class="text-danger">*</span></label>
                                <select class="form-select" id="budgetYear" required>
                                    <option value="">เลือกปีงบประมาณ</option>
                                    <option value="2568">2568</option>
                                    <option value="2569">2569</option>
                                    <option value="2570">2570</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ประเภทเงิน <span class="text-danger">*</span></label>
                                <select class="form-select" id="moneyType" required>
                                    <option value="">เลือกประเภทเงิน</option>
                                    <option value="ค่าจัดการเรียนการสอน">ค่าจัดการเรียนการสอน</option>
                                    <option value="ค่าหนังสือเรียน">ค่าหนังสือเรียน</option>
                                    <option value="ค่าอุปกรณ์การเรียน">ค่าอุปกรณ์การเรียน</option>
                                    <option value="ค่าเครื่องแบบนักเรียน">ค่าเครื่องแบบนักเรียน</option>
                                    <option value="ค่ากิจกรรมพัฒนาคุณภาพผู้เรียน">ค่ากิจกรรมพัฒนาคุณภาพผู้เรียน</option>
                                    <option value="ปัจจัยพื้นฐานนักเรียนยากจน">ปัจจัยพื้นฐานนักเรียนยากจน</option>
                                    <option value="อาหารกลางวัน">อาหารกลางวัน</option>
                                    <option value="รายได้สถานศึกษา">รายได้สถานศึกษา</option>
                                    <option value="กสศ.">กสศ.</option>
                                    <option value="ภาษี">ภาษี</option>
                                    <option value="ดอกเบี้ย">ดอกเบี้ย</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ประเภทรายการ <span class="text-danger">*</span></label>
                            <select class="form-select" id="transactionType" required>
                                <option value="">เลือกประเภทรายการ</option>
                                <option value="รับ">รับ</option>
                                <option value="จ่าย">จ่าย</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">บัญชี <span class="text-danger">*</span></label>
                            <select class="form-select" id="accountType" required>
                                <option value="">เลือกบัญชี</option>
                                <option value="เงินอุดหนุน">เงินอุดหนุน</option>
                                <option value="อาหารกลางวัน">อาหารกลางวัน</option>
                                <option value="รายได้สถานศึกษา">รายได้สถานศึกษา</option>
                                <option value="กสศ.">กสศ.</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">รายการ <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="description" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">จำนวนเงิน <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="amount" step="0.01" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary-custom" onclick="saveRecord()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Record Modal -->
    <div class="modal fade modal-custom" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">รายละเอียดรายการ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewModalBody">
                    <!-- Details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Date Range Modal -->
    <div class="modal fade modal-custom" id="exportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เลือกช่วงวันที่สำหรับ Export</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">วันที่เริ่มต้น <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="exportStartDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">วันที่สิ้นสุด <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="exportEndDate" required>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        ระบบจะส่งออกข้อมูลตามช่วงวันที่ที่เลือก พร้อมทั้งแยก Sheet ตามประเภทเงิน
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-success" onclick="confirmExport()">
                        <i class="fas fa-file-excel me-1"></i>ส่งออกข้อมูล
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, get, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCCVnXN5j7GhQEMRFLk7UJ2UsxAouPmB6w",
            authDomain: "listpayment-fe19e.firebaseapp.com",
            databaseURL: "https://listpayment-fe19e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "listpayment-fe19e",
            storageBucket: "listpayment-fe19e.firebasestorage.app",
            messagingSenderId: "643338335043",
            appId: "1:643338335043:web:0222b5664a68881ea2b5f6",
            measurementId: "G-WJXTV70VWQ"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Global variables
        let currentRecords = [];
        let filteredRecords = [];
        let currentPage = 1;
        let recordsPerPage = 20;
        let editingRecordId = null;

        // Money type colors
        const moneyTypeColors = {
            'ค่าจัดการเรียนการสอน': 'bg-primary',
            'ค่าหนังสือเรียน': 'bg-success',
            'ค่าอุปกรณ์การเรียน': 'bg-info',
            'ค่าเครื่องแบบนักเรียน': 'bg-warning',
            'ค่ากิจกรรมพัฒนาคุณภาพผู้เรียน': 'bg-danger',
            'ปัจจัยพื้นฐานนักเรียนยากจน': 'bg-secondary',
            'อาหารกลางวัน': 'bg-dark',
            'รายได้สถานศึกษา': 'bg-light text-dark',
            'กสศ.': 'bg-primary',
            'ภาษี': 'bg-success',
            'ดอกเบี้ย': 'bg-info'
        };

        // Show loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', {
                style: 'currency',
                currency: 'THB'
            }).format(amount);
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Load records from Firebase
        async function loadRecords() {
            showLoading();
            try {
                const recordsRef = ref(database, 'financial_records');
                const snapshot = await get(recordsRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    currentRecords = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                    
                    // Sort by date (newest first), then by created date
                    currentRecords.sort((a, b) => {
                        const aDate = new Date(a.date);
                        const bDate = new Date(b.date);
                        
                        // First sort by date (newest first)
                        if (aDate.getTime() !== bDate.getTime()) {
                            return bDate - aDate;
                        }
                        
                        // If dates are the same, sort by created time (newest first)
                        const aCreated = new Date(a.createdAt || a.date);
                        const bCreated = new Date(b.createdAt || b.date);
                        return bCreated - aCreated;
                    });
                } else {
                    currentRecords = [];
                }
                
                applyFilters();
            } catch (error) {
                console.error('Error loading records:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลได้', 'error');
            } finally {
                hideLoading();
            }
        }

        // Apply filters
        function applyFilters() {
            const monthFilter = document.getElementById('monthFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const moneyTypeFilter = document.getElementById('moneyTypeFilter').value;

            filteredRecords = currentRecords.filter(record => {
                const recordDate = new Date(record.date);
                const recordMonth = recordDate.getMonth() + 1;
                const recordYear = recordDate.getFullYear();

                let matchMonth = !monthFilter || recordMonth == monthFilter;
                let matchYear = !yearFilter || recordYear == yearFilter;
                let matchMoneyType = !moneyTypeFilter || record.moneyType === moneyTypeFilter;

                return matchMonth && matchYear && matchMoneyType;
            });

            currentPage = 1;
            displayRecords();
            displayPagination();
        }

        // Display records in table
        function displayRecords() {
            const tbody = document.getElementById('recordsTable');
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const recordsToShow = filteredRecords.slice(startIndex, endIndex);

            if (recordsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">ไม่พบข้อมูล</td></tr>';
                return;
            }

            tbody.innerHTML = recordsToShow.map(record => `
                <tr>
                    <td>${formatDate(record.date)}</td>
                    <td>${record.documentType}</td>
                    <td>${record.documentNumber}</td>
                    <td>${record.budgetYear}</td>
                    <td><span class="badge badge-money-type ${moneyTypeColors[record.moneyType] || 'bg-secondary'}">${record.moneyType}</span></td>
                    <td><span class="badge ${record.transactionType === 'รับ' ? 'bg-success' : 'bg-danger'}">${record.transactionType || 'ไม่ระบุ'}</span></td>
                    <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${record.description}">${record.description}</td>
                    <td class="text-end">${formatCurrency(record.amount)}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-info btn-sm-mobile" onclick="viewRecord('${record.id}')" title="ดูรายละเอียด">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-warning btn-sm-mobile" onclick="editRecord('${record.id}')" title="แก้ไข">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm-mobile" onclick="deleteRecord('${record.id}')" title="ลบ">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Display pagination
        function displayPagination() {
            const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // First page
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(1)">หน้าแรก</a>
                </li>
            `;

            // Previous page
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ก่อนหน้า</a>
                </li>
            `;

            // Page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }

            if (endPage < totalPages) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }

            // Next page
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ถัดไป</a>
                </li>
            `;

            // Last page
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${totalPages})">หน้าสุดท้าย</a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
        }

        // Change page
        window.changePage = function(page) {
            currentPage = page;
            displayRecords();
            displayPagination();
        };

        // Add new record
        window.addRecord = function() {
            editingRecordId = null;
            document.getElementById('modalTitle').textContent = 'เพิ่มรายการใหม่';
            document.getElementById('recordForm').reset();
            document.getElementById('customDocumentType').style.display = 'none';
            document.getElementById('accountType').value = '';
            new bootstrap.Modal(document.getElementById('recordModal')).show();
        };

        // Edit record
        window.editRecord = function(recordId) {
            const record = currentRecords.find(r => r.id === recordId);
            if (!record) return;

            editingRecordId = recordId;
            document.getElementById('modalTitle').textContent = 'แก้ไขรายการ';
            
            document.getElementById('recordDate').value = record.date;
            document.getElementById('documentType').value = record.documentType;
            document.getElementById('documentNumber').value = record.documentNumber;
            document.getElementById('budgetYear').value = record.budgetYear;
            document.getElementById('moneyType').value = record.moneyType;
            document.getElementById('transactionType').value = record.transactionType || '';
            document.getElementById('accountType').value = record.accountType || '';
            document.getElementById('description').value = record.description;
            document.getElementById('amount').value = record.amount;

            if (record.documentType === 'อื่นๆ') {
                document.getElementById('customDocumentType').style.display = 'block';
                document.getElementById('customDocumentType').value = record.customDocumentType || '';
            }

            new bootstrap.Modal(document.getElementById('recordModal')).show();
        };

        // View record details
        window.viewRecord = function(recordId) {
            const record = currentRecords.find(r => r.id === recordId);
            if (!record) return;

            const modalBody = document.getElementById('viewModalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <strong>วันที่:</strong><br>
                        ${formatDate(record.date)}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>ประเภทเอกสาร:</strong><br>
                        ${record.documentType}${record.customDocumentType ? ` (${record.customDocumentType})` : ''}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>เลขที่เอกสาร:</strong><br>
                        ${record.documentNumber}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>ปีงบประมาณ:</strong><br>
                        ${record.budgetYear}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>ประเภทเงิน:</strong><br>
                        <span class="badge badge-money-type ${moneyTypeColors[record.moneyType] || 'bg-secondary'}">${record.moneyType}</span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>ประเภทรายการ:</strong><br>
                        <span class="badge ${record.transactionType === 'รับ' ? 'bg-success' : 'bg-danger'}">${record.transactionType || 'ไม่ระบุ'}</span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>บัญชี:</strong><br>
                        ${record.accountType || 'ไม่ระบุ'}
                    </div>
                    <div class="col-12 mb-3">
                        <strong>รายการ:</strong><br>
                        <div class="p-2 bg-light rounded">${record.description}</div>
                    </div>
                    <div class="col-12 mb-3">
                        <strong>จำนวนเงิน:</strong><br>
                        <h4 class="text-success">${formatCurrency(record.amount)}</h4>
                    </div>
                </div>
            `;

            new bootstrap.Modal(document.getElementById('viewModal')).show();
        };

        // Save record
        window.saveRecord = function() {
            const form = document.getElementById('recordForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const recordData = {
                date: document.getElementById('recordDate').value,
                documentType: document.getElementById('documentType').value,
                documentNumber: document.getElementById('documentNumber').value,
                budgetYear: document.getElementById('budgetYear').value,
                moneyType: document.getElementById('moneyType').value,
                transactionType: document.getElementById('transactionType').value,
                accountType: document.getElementById('accountType').value,
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                createdAt: new Date().toISOString()
            };

            if (recordData.documentType === 'อื่นๆ') {
                recordData.customDocumentType = document.getElementById('customDocumentType').value;
            }

            showLoading();

            if (editingRecordId) {
                // Update existing record
                const recordRef = ref(database, `financial_records/${editingRecordId}`);
                recordData.updatedAt = new Date().toISOString();
                
                set(recordRef, recordData).then(() => {
                    hideLoading();
                    bootstrap.Modal.getInstance(document.getElementById('recordModal')).hide();
                    Swal.fire('สำเร็จ', 'แก้ไขรายการเรียบร้อยแล้ว', 'success');
                    loadRecords();
                }).catch(error => {
                    hideLoading();
                    console.error('Error updating record:', error);
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถแก้ไขรายการได้', 'error');
                });
            } else {
                // Add new record
                const recordsRef = ref(database, 'financial_records');
                push(recordsRef, recordData).then(() => {
                    hideLoading();
                    bootstrap.Modal.getInstance(document.getElementById('recordModal')).hide();
                    Swal.fire('สำเร็จ', 'เพิ่มรายการเรียบร้อยแล้ว', 'success');
                    loadRecords();
                }).catch(error => {
                    hideLoading();
                    console.error('Error adding record:', error);
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเพิ่มรายการได้', 'error');
                });
            }
        };

        // Delete record
        window.deleteRecord = function(recordId) {
            Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบรายการนี้หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    const recordRef = ref(database, `financial_records/${recordId}`);
                    remove(recordRef).then(() => {
                        hideLoading();
                        Swal.fire('ลบแล้ว', 'รายการถูกลบเรียบร้อยแล้ว', 'success');
                        loadRecords();
                    }).catch(error => {
                        hideLoading();
                        console.error('Error deleting record:', error);
                        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถลบรายการได้', 'error');
                    });
                }
            });
        };

        // Event listeners
        document.getElementById('monthFilter').addEventListener('change', applyFilters);
        document.getElementById('yearFilter').addEventListener('change', applyFilters);
        document.getElementById('moneyTypeFilter').addEventListener('change', applyFilters);

        document.getElementById('documentType').addEventListener('change', function() {
            const customField = document.getElementById('customDocumentType');
            if (this.value === 'อื่นๆ') {
                customField.style.display = 'block';
                customField.required = true;
            } else {
                customField.style.display = 'none';
                customField.required = false;
                customField.value = '';
            }
        });

        // Handle Enter key in modal
        document.getElementById('recordModal').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                saveRecord();
            }
        });

        // Close modal when clicking outside
        document.getElementById('recordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                bootstrap.Modal.getInstance(this).hide();
            }
        });

        document.getElementById('viewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                bootstrap.Modal.getInstance(this).hide();
            }
        });

        // Show export modal
        window.exportToExcel = function() {
            if (currentRecords.length === 0) {
                Swal.fire('ไม่มีข้อมูล', 'ไม่มีข้อมูลสำหรับส่งออก', 'warning');
                return;
            }

            // Set default date range (current month)
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            document.getElementById('exportStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('exportEndDate').value = lastDay.toISOString().split('T')[0];

            new bootstrap.Modal(document.getElementById('exportModal')).show();
        };

        // Confirm export with date range
        window.confirmExport = function() {
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;

            if (!startDate || !endDate) {
                Swal.fire('กรุณาเลือกวันที่', 'กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด', 'warning');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                Swal.fire('วันที่ไม่ถูกต้อง', 'วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด', 'warning');
                return;
            }

            // Filter records by date range
            const exportRecords = currentRecords.filter(record => {
                const recordDate = new Date(record.date);
                const start = new Date(startDate);
                const end = new Date(endDate);
                return recordDate >= start && recordDate <= end;
            });

            if (exportRecords.length === 0) {
                Swal.fire('ไม่มีข้อมูล', 'ไม่มีข้อมูลในช่วงวันที่ที่เลือก', 'warning');
                return;
            }

            // Close modal and start export
            bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
            performExport(exportRecords, startDate, endDate);
        };

        // Perform actual export
        function performExport(exportRecords, startDate, endDate) {
            showLoading();

            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Prepare data for all records sheet
                const allRecordsData = exportRecords.map(record => ({
                    'วันที่': formatDateForExcel(record.date),
                    'ประเภทเอกสาร': record.documentType + (record.customDocumentType ? ` (${record.customDocumentType})` : ''),
                    'เลขที่เอกสาร': record.documentNumber,
                    'ปีงบประมาณ': record.budgetYear,
                    'ประเภทเงิน': record.moneyType,
                    'ประเภทรายการ': record.transactionType || 'ไม่ระบุ',
                    'รายการ': record.description,
                    'จำนวนเงิน': record.amount
                }));

                // Create all records sheet
                const allRecordsWS = XLSX.utils.json_to_sheet(allRecordsData);
                
                // Set column widths for all records sheet
                allRecordsWS['!cols'] = [
                    { width: 15 }, // วันที่
                    { width: 15 }, // ประเภทเอกสาร
                    { width: 15 }, // เลขที่เอกสาร
                    { width: 12 }, // ปีงบประมาณ
                    { width: 25 }, // ประเภทเงิน
                    { width: 15 }, // ประเภทรายการ
                    { width: 40 }, // รายการ
                    { width: 15 }  // จำนวนเงิน
                ];

                XLSX.utils.book_append_sheet(wb, allRecordsWS, 'รายการทั้งหมด');

                // Group records by money type
                const recordsByMoneyType = {};
                exportRecords.forEach(record => {
                    if (!recordsByMoneyType[record.moneyType]) {
                        recordsByMoneyType[record.moneyType] = [];
                    }
                    recordsByMoneyType[record.moneyType].push(record);
                });

                // Create sheets for each money type
                Object.keys(recordsByMoneyType).forEach(moneyType => {
                    const records = recordsByMoneyType[moneyType];
                    const sheetData = records.map(record => ({
                        'วันที่': formatDateForExcel(record.date),
                        'ประเภทเอกสาร': record.documentType + (record.customDocumentType ? ` (${record.customDocumentType})` : ''),
                        'เลขที่เอกสาร': record.documentNumber,
                        'ปีงบประมาณ': record.budgetYear,
                        'ประเภทรายการ': record.transactionType || 'ไม่ระบุ',
                        'รายการ': record.description,
                        'จำนวนเงิน': record.amount
                    }));

                    // Add summary row
                    const totalAmount = records.reduce((sum, record) => sum + record.amount, 0);
                    const incomeAmount = records.filter(r => r.transactionType === 'รับ').reduce((sum, record) => sum + record.amount, 0);
                    const expenseAmount = records.filter(r => r.transactionType === 'จ่าย').reduce((sum, record) => sum + record.amount, 0);

                    sheetData.push({});
                    sheetData.push({
                        'วันที่': 'สรุป',
                        'ประเภทเอกสาร': '',
                        'เลขที่เอกสาร': '',
                        'ปีงบประมาณ': '',
                        'ประเภทรายการ': 'รวมรับ',
                        'รายการ': '',
                        'จำนวนเงิน': incomeAmount
                    });
                    sheetData.push({
                        'วันที่': '',
                        'ประเภทเอกสาร': '',
                        'เลขที่เอกสาร': '',
                        'ปีงบประมาณ': '',
                        'ประเภทรายการ': 'รวมจ่าย',
                        'รายการ': '',
                        'จำนวนเงิน': expenseAmount
                    });
                    sheetData.push({
                        'วันที่': '',
                        'ประเภทเอกสาร': '',
                        'เลขที่เอกสาร': '',
                        'ปีงบประมาณ': '',
                        'ประเภทรายการ': 'คงเหลือ',
                        'รายการ': '',
                        'จำนวนเงิน': incomeAmount - expenseAmount
                    });

                    const ws = XLSX.utils.json_to_sheet(sheetData);
                    
                    // Set column widths
                    ws['!cols'] = [
                        { width: 15 }, // วันที่
                        { width: 15 }, // ประเภทเอกสาร
                        { width: 15 }, // เลขที่เอกสาร
                        { width: 12 }, // ปีงบประมาณ
                        { width: 15 }, // ประเภทรายการ
                        { width: 40 }, // รายการ
                        { width: 15 }  // จำนวนเงิน
                    ];

                    // Truncate sheet name if too long (Excel limit is 31 characters)
                    let sheetName = moneyType;
                    if (sheetName.length > 31) {
                        sheetName = sheetName.substring(0, 28) + '...';
                    }

                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                // Group records by account type
                const recordsByAccountType = {};
                exportRecords.forEach(record => {
                    const accountType = record.accountType || 'ไม่ระบุบัญชี';
                    if (!recordsByAccountType[accountType]) {
                        recordsByAccountType[accountType] = [];
                    }
                    recordsByAccountType[accountType].push(record);
                });

                // Create sheets for each account type
                Object.keys(recordsByAccountType).forEach(accountType => {
                    const records = recordsByAccountType[accountType];
                    const sheetData = records.map(record => ({
                        'วันที่': formatDateForExcel(record.date),
                        'ประเภทเอกสาร': record.documentType + (record.customDocumentType ? ` (${record.customDocumentType})` : ''),
                        'เลขที่เอกสาร': record.documentNumber,
                        'ปีงบประมาณ': record.budgetYear,
                        'ประเภทเงิน': record.moneyType,
                        'ประเภทรายการ': record.transactionType || 'ไม่ระบุ',
                        'รายการ': record.description,
                        'จำนวนเงิน': record.amount
                    }));

                    // Add summary row
                    const incomeAmount = records.filter(r => r.transactionType === 'รับ').reduce((sum, record) => sum + record.amount, 0);
                    const expenseAmount = records.filter(r => r.transactionType === 'จ่าย').reduce((sum, record) => sum + record.amount, 0);

                    sheetData.push({});
                    sheetData.push({
                        'วันที่': 'สรุป',
                        'ประเภทเอกสาร': '',
                        'เลขที่เอกสาร': '',
                        'ปีงบประมาณ': '',
                        'ประเภทเงิน': '',
                        'ประเภทรายการ': 'รวมรับ',
                        'รายการ': '',
                        'จำนวนเงิน': incomeAmount
                    });
                    sheetData.push({
                        'วันที่': '',
                        'ประเภทเอกสาร': '',
                        'เลขที่เอกสาร': '',
                        'ปีงบประมาณ': '',
                        'ประเภทเงิน': '',
                        'ประเภทรายการ': 'รวมจ่าย',
                        'รายการ': '',
                        'จำนวนเงิน': expenseAmount
                    });
                    sheetData.push({
                        'วันที่': '',
                        'ประเภทเอกสาร': '',
                        'เลขที่เอกสาร': '',
                        'ปีงบประมาณ': '',
                        'ประเภทเงิน': '',
                        'ประเภทรายการ': 'คงเหลือ',
                        'รายการ': '',
                        'จำนวนเงิน': incomeAmount - expenseAmount
                    });

                    const ws = XLSX.utils.json_to_sheet(sheetData);
                    
                    // Set column widths
                    ws['!cols'] = [
                        { width: 15 }, // วันที่
                        { width: 15 }, // ประเภทเอกสาร
                        { width: 15 }, // เลขที่เอกสาร
                        { width: 12 }, // ปีงบประมาณ
                        { width: 25 }, // ประเภทเงิน
                        { width: 15 }, // ประเภทรายการ
                        { width: 40 }, // รายการ
                        { width: 15 }  // จำนวนเงิน
                    ];

                    // Truncate sheet name if too long (Excel limit is 31 characters)
                    let sheetName = `บัญชี_${accountType}`;
                    if (sheetName.length > 31) {
                        sheetName = sheetName.substring(0, 28) + '...';
                    }

                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                // Generate filename with date range
                const filename = `รายงานการเงิน_${formatDateForFilename(startDate)}_ถึง_${formatDateForFilename(endDate)}.xlsx`;

                // Write and download file
                XLSX.writeFile(wb, filename);

                hideLoading();
                Swal.fire('สำเร็จ', 'ส่งออกข้อมูลเรียบร้อยแล้ว', 'success');

            } catch (error) {
                hideLoading();
                console.error('Error exporting to Excel:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถส่งออกข้อมูลได้', 'error');
            }
        }

        // Format date for Excel
        function formatDateForExcel(dateString) {
            const date = new Date(dateString);
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
        }

        // Format date for filename
        function formatDateForFilename(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // Initialize
        loadRecords();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96c708eb06312dc4',t:'MTc1NDc0MDIxNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
